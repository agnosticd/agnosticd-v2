
{% set network = project_tag + "-network" %}
{% set subnet0 = project_tag + "-subnet0" %}

resources:

{# NETWORK #}
- name: {{ network }}
  type: compute.v1.network
  properties:
    autoCreateSubnetworks: false

- name: {{ subnet0 }}
  type: compute.v1.subnetwork
  properties:
    ipCidrRange: 10.254.0.0/24
    network: $(ref.{{ network }}.selfLink)
    region: {{ gcp_region }}

{# FIREWALL #}
{% for security_group in security_groups %}
- name: {{ security_group.name }}
  type: compute.v1.firewall
  properties:
    network: $(ref.{{ network }}.selfLink)
    allowed:
      - IPProtocol: {{ security_group.protocol | upper }}
        ports: [ "{{ security_group.from_port }}-{{ security_group.to_port }}" ]
    sourceRanges: [ "{{ security_group.cidr }}" ]
    targetTags: [ "{{ security_group.name }}" ]

{% endfor %}

- name: {{ 'allow-internal' }}
  type: compute.v1.firewall
  properties:
    network: $(ref.{{ network }}.selfLink)
    allowed:
      - IPProtocol: TCP
      - IPProtocol: UDP
    sourceRanges: ["10.254.0.0/24"]
    targetTags: [ "allow-internal" ]

{# INSTANCES #}
{% for instance in instances %}
- name: {{ instance.name }}
  type: compute.v1.instance
  properties:
    zone: {{ gcp_zone }}
    machineType: zones/{{ gcp_zone }}/machineTypes/{{ instance.flavor.gcp }}
    metadata:
      items:
        - key: ssh-keys
          value: "{{ ansible_user }}:{{ env_authorized_key_content_pub }} google-ssh {\"userName\":\"{{ remote_user }}\",\"expireOn\":\"{{ expire_time }}\"}"
    disks:
      - deviceName: boot
        type: PERSISTENT
        boot: true
        autoDelete: true
        initializeParams:
          diskName: {{ instance.name + '-disk' }}
          sourceImage: https://www.googleapis.com/compute/v1/projects/{{ instance.image.project }}/global/images/family/{{ instance.image.family }}
          diskSizeGb: {{ instance.rootfs_size | default(50) }}
          diskType: https://www.googleapis.com/compute/v1/projects/{{ project_tag }}/zones/{{ gcp_zone }}/diskTypes/{{ disk_type }}

{%if instance.volumes is defined %}
{% for volume in instance.volumes %}

      - deviceName: {{ volume.name }}-additional-disk
        type: PERSISTENT
        boot: false
        autoDelete: true
        initializeParams:
          diskName: {{ instance.name + volume.name + '-additional-disk' }}
          diskSizeGb: {{ volume.size | default(20) }}
          diskType: https://www.googleapis.com/compute/v1/projects/{{ project_tag }}/zones/{{ gcp_zone }}/diskTypes/{{ disk_type }}

{% endfor %}
{% endif %}
    networkInterfaces:
      - network: $(ref.{{ network }}.selfLink)
        subnetwork: $(ref.{{ subnet0 }}.selfLink)
        accessConfigs:
          - name: External NAT
            type: ONE_TO_ONE_NAT

{%if instance.nested_virtualization is defined %}
{%if instance.nested_virtualization | bool %}

    advancedMachineFeatures:
      enableNestedVirtualization: true

{% endif %}
{% endif %}

    labels:
      {% for tag in instance.tags %}

      {{ tag.key }}: {{ tag.value }}
      {% endfor %}

      project: {{ project_tag }}

    tags:
      items: {{ ['allow-internal']  + instance.security_groups | default([]) }}
    serviceAccounts:
      - email: default
        scopes:
          - 'https://www.googleapis.com/auth/compute'
          - 'https://www.googleapis.com/auth/devstorage.read_only'
          - 'https://www.googleapis.com/auth/logging.write'
          - 'https://www.googleapis.com/auth/monitoring.write'
          - 'https://www.googleapis.com/auth/servicecontrol'
          - 'https://www.googleapis.com/auth/service.management'
          - 'https://www.googleapis.com/auth/trace.append'
          - 'https://www.googleapis.com/auth/userinfo.email'

{% endfor %}

outputs:
